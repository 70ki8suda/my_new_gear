# My New Gear! – Backend README

## 1. Product Overview

"My New Gear!" は Twitter と Instagram の中間的な体験を提供するソーシャル Web アプリです。ユーザーはお気に入りの **アイテム** を登録し、自由につけたタグで整理できます。各アイテムに対して写真付きの短文ポスト（以下「ツイート」）を時系列で積み重ねられ、他ユーザーやタグをフォローしてタイムラインを閲覧できます。

---

## 2. Core Features

| #   | 機能                 | 概要                                                       |
| --- | -------------------- | ---------------------------------------------------------- |
| 1   | アイテム管理 　      | 名称・説明・代表写真を保持し、任意タグを付与               |
| 2   | ポスト（ツイート）　 | 280 文字・画像 0–4 枚。必ず 1 アイテムに紐付く             |
| 3   | コメント　　         | ポストに対してリプライ形式でコメント（140 文字・画像なし） |
| 4   | フォロー             | ユーザー ↔ ユーザー、ユーザー ↔ タグ                     |
| 5   | いいね               | ポストに対して 1 ユーザー 1 いいね                         |
| 6   | フィード             | フォローしたユーザー・タグ・自分の投稿を統合（降順）       |
| 7   | 検索                 | ユーザー／タグ／アイテム／ポスト全文検索（PostgreSQL FTS） |
| 8   | 通知                 | フォロー・いいね・コメントで通知生成                       |
| 9   | 認証                 | Email+Password（JWT）＋ OAuth2 拡張想定                    |

---

## 3. Domain Model

```
User ---< Item ---< Post >--- Photo
  |                |
  |                >--- Like
  |                     ^
  |                     |
Follow  >--- User        |
TagFollow >--- Tag ------|
ItemTag   >--- Tag       |
Comment  ---< Post       |
Notification ----------- |
```

---

## 4. Relational Schema (PostgreSQL)

`id` はすべて `BIGINT GENERATED BY DEFAULT AS IDENTITY`。時刻は `TIMESTAMPTZ`。

### 4.1 `users`

| column        | type         | constraints & notes     |
| ------------- | ------------ | ----------------------- |
| id            | BIGINT       | PK                      |
| username      | VARCHAR(32)  | UNIQUE, NOT NULL, INDEX |
| email         | VARCHAR(255) | UNIQUE, NOT NULL        |
| password_hash | TEXT         | NOT NULL                |
| bio           | TEXT         |                         |
| avatar_url    | TEXT         |                         |
| created_at    | TIMESTAMPTZ  | DEFAULT now()           |
| updated_at    | TIMESTAMPTZ  |                         |

### 4.2 `items`

| column           | type        | constraints & notes              |
| ---------------- | ----------- | -------------------------------- |
| id               | BIGINT      | PK                               |
| user_id          | BIGINT      | FK → users(id) ON DELETE CASCADE |
| name             | VARCHAR(64) | NOT NULL                         |
| description      | TEXT        |                                  |
| default_photo_id | BIGINT      | FK → photos(id) NULLABLE         |
| created_at       | TIMESTAMPTZ | DEFAULT now()                    |
| updated_at       | TIMESTAMPTZ |                                  |

### 4.3 `tags`

| column     | type        | constraints & notes     |
| ---------- | ----------- | ----------------------- |
| id         | BIGINT      | PK                      |
| name       | VARCHAR(32) | UNIQUE, NOT NULL, INDEX |
| created_at | TIMESTAMPTZ | DEFAULT now()           |

### 4.4 `item_tags` (M:M Items ↔ Tags)

| item_id               | tag_id               | added_at                  |
| --------------------- | -------------------- | ------------------------- |
| BIGINT PK, FK → items | BIGINT PK, FK → tags | TIMESTAMPTZ DEFAULT now() |

### 4.5 `posts`

| column     | type         | constraints & notes                             |
| ---------- | ------------ | ----------------------------------------------- |
| id         | BIGINT       | PK                                              |
| item_id    | BIGINT       | FK → items(id) ON DELETE CASCADE                |
| author_id  | BIGINT       | FK → users(id)                                  |
| content    | VARCHAR(280) | NOT NULL                                        |
| created_at | TIMESTAMPTZ  | DEFAULT now(), INDEX (item_id, created_at DESC) |
| updated_at | TIMESTAMPTZ  |                                                 |

### 4.6 `comments`

| column     | type         | constraints & notes                            |
| ---------- | ------------ | ---------------------------------------------- |
| id         | BIGINT       | PK                                             |
| post_id    | BIGINT       | FK → posts(id) ON DELETE CASCADE               |
| author_id  | BIGINT       | FK → users(id)                                 |
| content    | VARCHAR(140) | NOT NULL                                       |
| created_at | TIMESTAMPTZ  | DEFAULT now(), INDEX (post_id, created_at ASC) |

### 4.7 `photos`

| column      | type        | constraints & notes                       |
| ----------- | ----------- | ----------------------------------------- |
| id          | BIGINT      | PK                                        |
| post_id     | BIGINT      | FK → posts(id) NULLABLE ON DELETE CASCADE |
| item_id     | BIGINT      | FK → items(id) NULLABLE                   |
| uploader_id | BIGINT      | FK → users(id)                            |
| url         | TEXT        | NOT NULL                                  |
| width       | INT         |                                           |
| height      | INT         |                                           |
| created_at  | TIMESTAMPTZ | DEFAULT now()                             |

### 4.8 `follows` (User ↔ User)

| follower_id           | followee_id           | created_at                |
| --------------------- | --------------------- | ------------------------- |
| BIGINT PK, FK → users | BIGINT PK, FK → users | TIMESTAMPTZ DEFAULT now() |

### 4.9 `tag_follows`

| follower_id           | tag_id               | created_at                |
| --------------------- | -------------------- | ------------------------- |
| BIGINT PK, FK → users | BIGINT PK, FK → tags | TIMESTAMPTZ DEFAULT now() |

### 4.10 `likes`

| user_id               | post_id               | created_at                |
| --------------------- | --------------------- | ------------------------- |
| BIGINT PK, FK → users | BIGINT PK, FK → posts | TIMESTAMPTZ DEFAULT now() |

### 4.11 `notifications`

| column     | type        | constraints & notes                       |
| ---------- | ----------- | ----------------------------------------- |
| id         | BIGINT      | PK                                        |
| user_id    | BIGINT      | FK → users                                |
| type       | VARCHAR(16) | ENUM[follower, like, comment, tag_follow] |
| actor_id   | BIGINT      | FK → users NULLABLE                       |
| subject_id | BIGINT      | Context FK (e.g., post_id, comment_id)    |
| created_at | TIMESTAMPTZ | DEFAULT now()                             |
| is_read    | BOOLEAN     | DEFAULT false                             |

---

## 5. REST API (v1)

| Method | Path                        | 説明               | リクエスト                                | レスポンス                               |
| ------ | --------------------------- | ------------------ | ----------------------------------------- | ---------------------------------------- |
| POST   | /api/auth/signup            | サインアップ       | `{username, email, password}`             | `{message, user: {id, username, email}}` |
| POST   | /api/auth/login             | ログイン (JWT)     | `{email, password}`                       | `{message, token}`                       |
| GET    | /api/users/me               | ユーザー情報取得   | Auth Header                               | `{user: {...}}`                          |
| PUT    | /api/users/me               | ユーザー情報更新   | Auth Header, `{bio, avatarUrl}`           | `{message, user: {...}}`                 |
| GET    | /api/feed                   | フィード取得       | Auth Header, Query params (limit, offset) | `{posts: [...]}`                         |
| GET    | /api/items                  | アイテム一覧取得   | Auth Header                               | `{items: [...]}`                         |
| POST   | /api/items                  | アイテム作成       | Auth Header, `{name, description}`        | `{message, item: {...}}`                 |
| GET    | /api/items/:itemId          | アイテム詳細取得   | -                                         | `{item: {...}}`                          |
| PUT    | /api/items/:itemId          | アイテム更新       | Auth Header, `{name, description}`        | `{message, item: {...}}`                 |
| DELETE | /api/items/:itemId          | アイテム削除       | Auth Header                               | `{message}`                              |
| POST   | /api/items/:itemId/posts    | ポスト作成         | Auth Header, `{content, photoUrls}`       | `{message, post: {...}}`                 |
| GET    | /api/posts/:postId          | ポスト詳細取得     | -                                         | `{post: {...}}`                          |
| POST   | /api/posts/:postId/like     | いいね             | Auth Header                               | `{message, likesCount}`                  |
| DELETE | /api/posts/:postId/like     | いいね解除         | Auth Header                               | `{message, likesCount}`                  |
| GET    | /api/posts/:postId/comments | コメント一覧取得   | Query params (limit, offset)              | `{comments: [...]}`                      |
| POST   | /api/posts/:postId/comments | コメント作成       | Auth Header, `{content}`                  | `{message, comment: {...}}`              |
| POST   | /api/users/:userId/follow   | ユーザーをフォロー | Auth Header                               | `{message, followersCount}`              |
| DELETE | /api/users/:userId/follow   | フォロー解除       | Auth Header                               | `{message, followersCount}`              |
| GET    | /api/tags                   | タグ一覧取得       | Query params (limit, offset)              | `{tags: [...]}`                          |
| POST   | /api/tags/:tagName/follow   | タグをフォロー     | Auth Header                               | `{message, followersCount}`              |
| DELETE | /api/tags/:tagName/follow   | タグのフォロー解除 | Auth Header                               | `{message, followersCount}`              |
| GET    | /api/notifications          | 通知一覧取得       | Auth Header, Query params (limit, offset) | `{notifications: [...]}`                 |
| PUT    | /api/notifications/:id/read | 通知を既読にする   | Auth Header                               | `{message, notification: {...}}`         |
| GET    | /api/search                 | 検索               | Query params (q, type, limit, offset)     | 検索結果（タイプによって異なる）         |

### エンドポイント詳細

#### 認証

- **POST /api/auth/signup**: 新規ユーザー登録

  - リクエスト: `{username, email, password}`
  - レスポンス: `{message: "ユーザーが正常に登録されました", user: {id, username, email, createdAt}}`

- **POST /api/auth/login**: ログイン
  - リクエスト: `{email, password}`
  - レスポンス: `{message: "ログインに成功しました", token: "JWT_TOKEN"}`

#### ユーザー管理

- **GET /api/users/me**: ログインユーザーの情報取得

  - 認証: 必須
  - レスポンス: `{user: {id, username, email, bio, avatarUrl, createdAt, updatedAt}}`

- **PUT /api/users/me**: ユーザー情報更新
  - 認証: 必須
  - リクエスト: `{bio, avatarUrl}`
  - レスポンス: `{message: "プロフィールが更新されました", user: {...}}`

#### アイテム管理

- **GET /api/items**: ログインユーザーのアイテム一覧

  - 認証: 必須
  - レスポンス: `{items: [{id, name, description, ...}, ...]}`

- **POST /api/items**: 新しいアイテム作成

  - 認証: 必須
  - リクエスト: `{name, description, defaultPhotoId?}`
  - レスポンス: `{message: "アイテムが正常に作成されました", item: {...}}`

- **GET /api/items/:itemId**: アイテム詳細取得

  - レスポンス: `{item: {id, name, description, userId, createdAt, ...}}`

- **PUT /api/items/:itemId**: アイテム更新

  - 認証: 必須（所有者のみ）
  - リクエスト: `{name?, description?, defaultPhotoId?}`
  - レスポンス: `{message: "アイテムが正常に更新されました", item: {...}}`

- **DELETE /api/items/:itemId**: アイテム削除
  - 認証: 必須（所有者のみ）
  - レスポンス: `{message: "アイテムが正常に削除されました"}`

---

## 6. Index & Performance

- **タイムライン**: `posts(created_at DESC)` + `comments(created_at ASC)`
- **全文検索**: `posts_fts` と `comments_fts` (to_tsvector) に対し GIN index
- **タグ検索**: `tags(name)` trigram GIN
- **キャッシュ**: Redis による TL キャッシュ or Fan‑out on write
- **リアルタイム**: クライアント側で 5–10 s 間隔のポーリング (Etag/Last‑Modified)

---

## 7. Non‑Functional Requirements

| 項目         | 目標                                 |
| ------------ | ------------------------------------ |
| RPS          | 1000 req/s スパイク耐性              |
| 可用性       | 99.9 % / 月                          |
| ストレージ   | 画像: S3 互換 + CDN                  |
| ロギング     | JSON + OpenTelemetry Tracing         |
| バックアップ | DB 毎日スナップショット (保持 30 日) |

---

## 8. 設計決定

- ポスト編集履歴 **不要**
- アイテム共同編集 **不要**
- プライバシー設定 **なし** (全投稿公開)
- 全文検索: **PostgreSQL FTS** で実装
- リアルタイム: **ポーリング**
- データベース: **PostgreSQL**
- **IDの型安全性**: `UserId`, `ItemId`, `PostId` などのIDを表す数値型には、誤用を防ぐために **Branded Types** を使用します。これにより、例えば `UserId` を期待する箇所に誤って `PostId` を渡してしまうといったミスをコンパイル時に検出できます。

---

## 9. 技術スタック

| カテゴリ           | 技術       | 説明                                     |
| ------------------ | ---------- | ---------------------------------------- |
| パッケージ管理     | pnpm       | 高速で効率的なノードパッケージマネージャ |
| フレームワーク     | Hono       | 軽量で高速なWebフレームワーク            |
| ORM                | Drizzle    | TypeScript用の型安全なSQLツールキット    |
| 型とバリデーション | Zod        | TypeScript用のスキーマ検証ライブラリ     |
| データベース       | PostgreSQL | 強力な関係データベース                   |
| ビルドツール       | Vite       | 高速なWebアプリケーションビルドツール    |

## 10. Docker設定

My New Gearプロジェクトはコンテナ化されており、Docker Composeを使用して環境全体を簡単に起動できます。

### Dockerの構成

| コンテナ | 説明                         | ポート    |
| -------- | ---------------------------- | --------- |
| app      | Honoアプリケーションサーバー | 3000:3000 |
| postgres | PostgreSQLデータベース       | 5432:5432 |

### 起動方法

以下のコマンドでDockerコンテナを起動できます：

```bash
# コンテナのビルドと起動
docker-compose up --build

# バックグラウンドで実行する場合
docker-compose up -d
```

### 開発時の利用

```bash
# アプリケーションログの確認
docker-compose logs -f app

# データベースコンテナに接続
docker-compose exec postgres psql -U postgres -d my_new_gear

# コンテナの停止
docker-compose down
```

## 11. テスト

このプロジェクトでは、Vitestを使用した包括的なテスト戦略を採用しています。

### テスト構造

- **単体テスト** (`tests/unit/`): サービス、ユーティリティ、バリデーションロジックの個別テスト
- **統合テスト** (`tests/integration/`): ルートハンドラーとデータベースの連携テスト
- **E2Eテスト** (`tests/e2e/`): 実際のAPIエンドポイントとユーザーフローのテスト

### テスト実行手順

#### 1. テスト環境のセットアップ

```bash
# テスト用のDockerコンテナを起動（PostgreSQLテスト用DB）
docker-compose -f docker-compose.test.yml up -d postgres_test

# テスト用DBのマイグレーションを実行
pnpm db:migrate:test
```

#### 2. テストの実行

```bash
# すべてのテストを実行
pnpm test

# 単体テストのみ実行
pnpm test:unit

# 統合テストのみ実行
pnpm test:integration

# E2Eテストのみ実行
pnpm test:e2e

# テストを監視モードで実行（ファイル変更時に自動実行）
pnpm test:watch

# カバレッジレポートを生成
pnpm test:coverage
```

#### 3. Dockerを使ったテスト実行

すべてのテストをDockerコンテナ内で実行することもできます：

```bash
# テスト用コンテナを使ってすべてのテストを実行
docker-compose -f docker-compose.test.yml up --build

# コンテナ内のテスト結果を確認
docker-compose -f docker-compose.test.yml logs -f app_test

# テスト環境のクリーンアップ
docker-compose -f docker-compose.test.yml down
```

### テストコマンド詳細

| コマンド                | 説明                                               |
| ----------------------- | -------------------------------------------------- |
| `pnpm test`             | すべてのテストを1回実行します                      |
| `pnpm test:watch`       | ファイル変更を監視して自動的にテストを再実行します |
| `pnpm test:unit`        | 単体テストのみを実行します                         |
| `pnpm test:integration` | 統合テストのみを実行します                         |
| `pnpm test:e2e`         | E2Eテストのみを実行します                          |
| `pnpm test:coverage`    | テストカバレッジレポートを生成します               |

### テスト環境の設定

1. テスト用のデータベースは `docker-compose.test.yml` で提供されています
2. テスト実行前に `pnpm db:migrate:test` でテスト用DBのマイグレーションを実行してください
3. 詳細な設定は `vitest.config.ts` と `tests/setup.ts` を参照してください

### テスト実装例

#### 単体テスト例（サービス）

```typescript
// tests/unit/services/auth.service.test.ts
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { loginUser, signupUser } from '../../../src/services/auth.service';
import { mockDb } from '../../mocks/db';
import { HTTPException } from 'hono/http-exception';

// モックの設定
vi.mock('../../../src/db', () => ({
  db: mockDb,
}));

describe('Auth Service', () => {
  beforeEach(() => {
    // テスト毎にモックをリセット
    vi.clearAllMocks();
  });

  describe('signupUser', () => {
    it('should create a new user', async () => {
      // モックの戻り値を設定
      mockDb.execute.mockResolvedValueOnce([{ id: 1, username: 'testuser' }]);

      const result = await signupUser({
        username: 'testuser',
        email: 'test@example.com',
        password: 'Password123!',
      });

      expect(result).toHaveProperty('id', 1);
      expect(result).toHaveProperty('username', 'testuser');
    });
  });
});
```

#### 統合テスト例（ルート）

```typescript
// tests/integration/routes/auth.route.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { app } from '../../../src';
import { db } from '../../../src/db';

describe('Auth Routes', () => {
  beforeEach(async () => {
    // テストDBをクリーンに
    await db.delete('users').execute();
  });

  describe('POST /api/auth/signup', () => {
    it('should register a new user', async () => {
      const res = await app.request('/api/auth/signup', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: 'testuser',
          email: 'test@example.com',
          password: 'Password123!',
        }),
      });

      expect(res.status).toBe(201);
      const data = await res.json();
      expect(data).toHaveProperty('message');
      expect(data).toHaveProperty('user.username', 'testuser');
    });
  });
});
```

#### E2Eテスト例（フロー）

```typescript
// tests/e2e/flows/user-item-flow.test.ts
import { describe, it, expect, beforeAll } from 'vitest';
import { app } from '../../../src';

describe('User Item Flow', () => {
  let authToken: string;
  let userId: number;
  let itemId: number;

  beforeAll(async () => {
    // ユーザー登録
    const signupRes = await app.request('/api/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: 'flowuser',
        email: 'flow@example.com',
        password: 'Password123!',
      }),
    });

    const signupData = await signupRes.json();
    userId = signupData.user.id;

    // ログイン
    const loginRes = await app.request('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'flow@example.com',
        password: 'Password123!',
      }),
    });

    const loginData = await loginRes.json();
    authToken = loginData.token;
  });

  it('should allow user to create and retrieve items', async () => {
    // アイテム作成テスト
    // ...
    // アイテム取得テスト
    // ...
  });
});
```
