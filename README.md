# My New Gear! – Backend README

## 1. Product Overview

"My New Gear!" は Twitter と Instagram の中間的な体験を提供するソーシャル Web アプリです。ユーザーはお気に入りの **アイテム** を登録し、自由につけたタグで整理できます。各アイテムに対して写真付きの短文ポスト（以下「ツイート」）を時系列で積み重ねられ、他ユーザーやタグをフォローしてタイムラインを閲覧できます。

---

## 2. Core Features

| #   | 機能                 | 概要                                                       |
| --- | -------------------- | ---------------------------------------------------------- |
| 1   | アイテム管理 　      | 名称・説明・代表写真を保持し、任意タグを付与               |
| 2   | ポスト（ツイート）　 | 280 文字・画像 0–4 枚。必ず 1 アイテムに紐付く             |
| 3   | コメント　　         | ポストに対してリプライ形式でコメント（140 文字・画像なし） |
| 4   | フォロー             | ユーザー ↔ ユーザー、ユーザー ↔ タグ                     |
| 5   | いいね               | ポストに対して 1 ユーザー 1 いいね                         |
| 6   | フィード             | フォローしたユーザー・タグ・自分の投稿を統合（降順）       |
| 7   | 検索                 | ユーザー／タグ／アイテム／ポスト全文検索（PostgreSQL FTS） |
| 8   | 通知                 | フォロー・いいね・コメントで通知生成                       |
| 9   | 認証                 | Email+Password（JWT）＋ OAuth2 拡張想定                    |

---

## 3. Domain Model

```
User ---< Item ---< Post >--- Photo
  |                |
  |                >--- Like
  |                     ^
  |                     |
Follow  >--- User        |
TagFollow >--- Tag ------|
ItemTag   >--- Tag       |
Comment  ---< Post       |
Notification ----------- |
```

---

## 4. Relational Schema (PostgreSQL)

`id` はすべて `BIGINT GENERATED BY DEFAULT AS IDENTITY`。時刻は `TIMESTAMPTZ`。

### 4.1 `users`

| column        | type         | constraints & notes     |
| ------------- | ------------ | ----------------------- |
| id            | BIGINT       | PK                      |
| username      | VARCHAR(32)  | UNIQUE, NOT NULL, INDEX |
| email         | VARCHAR(255) | UNIQUE, NOT NULL        |
| password_hash | TEXT         | NOT NULL                |
| bio           | TEXT         |                         |
| avatar_url    | TEXT         |                         |
| created_at    | TIMESTAMPTZ  | DEFAULT now()           |
| updated_at    | TIMESTAMPTZ  |                         |

### 4.2 `items`

| column           | type        | constraints & notes              |
| ---------------- | ----------- | -------------------------------- |
| id               | BIGINT      | PK                               |
| user_id          | BIGINT      | FK → users(id) ON DELETE CASCADE |
| name             | VARCHAR(64) | NOT NULL                         |
| description      | TEXT        |                                  |
| default_photo_id | BIGINT      | FK → photos(id) NULLABLE         |
| created_at       | TIMESTAMPTZ | DEFAULT now()                    |
| updated_at       | TIMESTAMPTZ |                                  |

### 4.3 `tags`

| column     | type        | constraints & notes     |
| ---------- | ----------- | ----------------------- |
| id         | BIGINT      | PK                      |
| name       | VARCHAR(32) | UNIQUE, NOT NULL, INDEX |
| created_at | TIMESTAMPTZ | DEFAULT now()           |

### 4.4 `item_tags` (M:M Items ↔ Tags)

| item_id               | tag_id               | added_at                  |
| --------------------- | -------------------- | ------------------------- |
| BIGINT PK, FK → items | BIGINT PK, FK → tags | TIMESTAMPTZ DEFAULT now() |

### 4.5 `posts`

| column     | type         | constraints & notes                             |
| ---------- | ------------ | ----------------------------------------------- |
| id         | BIGINT       | PK                                              |
| item_id    | BIGINT       | FK → items(id) ON DELETE CASCADE                |
| author_id  | BIGINT       | FK → users(id)                                  |
| content    | VARCHAR(280) | NOT NULL                                        |
| created_at | TIMESTAMPTZ  | DEFAULT now(), INDEX (item_id, created_at DESC) |
| updated_at | TIMESTAMPTZ  |                                                 |

### 4.6 `comments`

| column     | type         | constraints & notes                            |
| ---------- | ------------ | ---------------------------------------------- |
| id         | BIGINT       | PK                                             |
| post_id    | BIGINT       | FK → posts(id) ON DELETE CASCADE               |
| author_id  | BIGINT       | FK → users(id)                                 |
| content    | VARCHAR(140) | NOT NULL                                       |
| created_at | TIMESTAMPTZ  | DEFAULT now(), INDEX (post_id, created_at ASC) |

### 4.7 `photos`

| column      | type        | constraints & notes                       |
| ----------- | ----------- | ----------------------------------------- |
| id          | BIGINT      | PK                                        |
| post_id     | BIGINT      | FK → posts(id) NULLABLE ON DELETE CASCADE |
| item_id     | BIGINT      | FK → items(id) NULLABLE                   |
| uploader_id | BIGINT      | FK → users(id)                            |
| url         | TEXT        | NOT NULL                                  |
| width       | INT         |                                           |
| height      | INT         |                                           |
| created_at  | TIMESTAMPTZ | DEFAULT now()                             |

### 4.8 `follows` (User ↔ User)

| follower_id           | followee_id           | created_at                |
| --------------------- | --------------------- | ------------------------- |
| BIGINT PK, FK → users | BIGINT PK, FK → users | TIMESTAMPTZ DEFAULT now() |

### 4.9 `tag_follows`

| follower_id           | tag_id               | created_at                |
| --------------------- | -------------------- | ------------------------- |
| BIGINT PK, FK → users | BIGINT PK, FK → tags | TIMESTAMPTZ DEFAULT now() |

### 4.10 `likes`

| user_id               | post_id               | created_at                |
| --------------------- | --------------------- | ------------------------- |
| BIGINT PK, FK → users | BIGINT PK, FK → posts | TIMESTAMPTZ DEFAULT now() |

### 4.11 `notifications`

| column     | type        | constraints & notes                       |
| ---------- | ----------- | ----------------------------------------- |
| id         | BIGINT      | PK                                        |
| user_id    | BIGINT      | FK → users                                |
| type       | VARCHAR(16) | ENUM[follower, like, comment, tag_follow] |
| actor_id   | BIGINT      | FK → users NULLABLE                       |
| subject_id | BIGINT      | Context FK (e.g., post_id, comment_id)    |
| created_at | TIMESTAMPTZ | DEFAULT now()                             |
| is_read    | BOOLEAN     | DEFAULT false                             |

---

## 5. REST API (v1)

| Method | Path                    | 説明               |
| ------ | ----------------------- | ------------------ |
| POST   | /auth/signup            | サインアップ       |
| POST   | /auth/login             | ログイン (JWT)     |
| GET    | /feed                   | フィード取得       |
| ---    | ---                     | ---                |
| POST   | /items                  | アイテム作成       |
| GET    | /items/:itemId          | アイテム詳細       |
| ---    | ---                     | ---                |
| POST   | /items/:itemId/posts    | ポスト作成         |
| GET    | /posts/:postId          | ポスト詳細         |
| POST   | /posts/:postId/like     | いいね             |
| DELETE | /posts/:postId/like     | いいね解除         |
| POST   | /posts/:postId/comments | コメント作成       |
| GET    | /posts/:postId/comments | コメント一覧       |
| ---    | ---                     | ---                |
| POST   | /users/:userId/follow   | ユーザーをフォロー |
| DELETE | /users/:userId/follow   | フォロー解除       |
| POST   | /tags/:tagName/follow   | タグをフォロー     |
| DELETE | /tags/:tagName/follow   | フォロー解除       |
| GET    | /notifications          | 通知一覧           |

---

## 6. Index & Performance

- **タイムライン**: `posts(created_at DESC)` + `comments(created_at ASC)`
- **全文検索**: `posts_fts` と `comments_fts` (to_tsvector) に対し GIN index
- **タグ検索**: `tags(name)` trigram GIN
- **キャッシュ**: Redis による TL キャッシュ or Fan‑out on write
- **リアルタイム**: クライアント側で 5–10 s 間隔のポーリング (Etag/Last‑Modified)

---

## 7. Non‑Functional Requirements

| 項目         | 目標                                 |
| ------------ | ------------------------------------ |
| RPS          | 1000 req/s スパイク耐性              |
| 可用性       | 99.9 % / 月                          |
| ストレージ   | 画像: S3 互換 + CDN                  |
| ロギング     | JSON + OpenTelemetry Tracing         |
| バックアップ | DB 毎日スナップショット (保持 30 日) |

---

## 8. 設計決定

- ポスト編集履歴 **不要**
- アイテム共同編集 **不要**
- プライバシー設定 **なし** (全投稿公開)
- 全文検索: **PostgreSQL FTS** で実装
- リアルタイム: **ポーリング**
- データベース: **PostgreSQL**

---

## 9. 技術スタック

| カテゴリ           | 技術       | 説明                                     |
| ------------------ | ---------- | ---------------------------------------- |
| パッケージ管理     | pnpm       | 高速で効率的なノードパッケージマネージャ |
| フレームワーク     | Hono       | 軽量で高速なWebフレームワーク            |
| ORM                | Drizzle    | TypeScript用の型安全なSQLツールキット    |
| 型とバリデーション | Zod        | TypeScript用のスキーマ検証ライブラリ     |
| データベース       | PostgreSQL | 強力な関係データベース                   |
